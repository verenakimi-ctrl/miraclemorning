<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MiracleMorning</title>
  <style>
    body { margin:0; font-family: system-ui, Arial, sans-serif; background:#f7f7fb; color:#222; }
    header { background:#6a5acd; color:#fff; padding:20px; text-align:center; }
    main { max-width:800px; margin:24px auto; padding:0 16px; }
    .card { background:#fff; border:1px solid #eee; border-radius:12px; padding:20px; box-shadow:0 4px 12px rgba(0,0,0,.06); }
    h1 { margin:0; }
    .muted { color:#666; }
    footer { text-align:center; padding:24px; color:#888; }
    a.btn { display:inline-block; padding:10px 16px; border-radius:8px; text-decoration:none; border:1px solid #6a5acd; color:#6a5acd; }
    a.btn:hover { background:#6a5acd; color:#fff; }
  </style>
</head>
<body>
  <header>
    <h1>üåÖ MiracleMorning</h1>
    <div class="muted">Daily routine tracker (Pi Hackathon)</div>
  </header>

  <main>
    <div class="card">
      <h2>Welcome!</h2>
      <p>This is a simple home page deployed on Vercel.</p>
      <p class="muted">Next: connect this URL in Pi Developer Portal (Step 5).</p>
      <a class="btn" href="#" onclick="alert('Coming soon!')">Start</a>
    </div>
  </main>

  <footer>¬© 2025 MiracleMorning</footer>

  <!-- Pi SDK Ìè¨Ìï® -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <script>
    // Pi SDK Ï¥àÍ∏∞Ìôî (ÌÖåÏä§Ìä∏Ïö© sandbox Î™®Îìú)
    Pi.init({ version: "2.0", sandbox: true });

    // Ïù∏Ï¶ù Ìï®Ïàò (ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ïã§Ìñâ)
    async function ensureAuth() {
      try {
        const auth = await Pi.authenticate(["payments"], (p) => console.log("incomplete payment:", p));
        if (auth.user) {
          console.log("‚úÖ Authenticated with payments scope");
        } else {
          throw new Error("Authentication failed: no user data");
        }
      } catch (e) {
        console.error("Auth failed:", e?.message || e);
        alert("Authentication failed. Ensure 'payments' scope is enabled in Pi Developer Portal.");
      }
    }
    window.onload = ensureAuth;

    // Í≤∞Ï†ú ÌÖåÏä§Ìä∏ Ìï®Ïàò
    async function testPayment() {
      try {
        const paymentData = {
          amount: 0.01,
          memo: "MiracleMorning test payment",
          metadata: { source: "demo" },
        };

        const callbacks = {
          onReadyForServerApproval: async (paymentId) => {
            console.log("Server approval needed for:", paymentId);
            const response = await fetch("/api/approve", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ paymentId }),
            });
            if (!response.ok) throw new Error("Server approval failed");
            const result = await response.json();
            console.log("Approval response:", result);
          },
          onReadyForServerCompletion: async (paymentId, txid) => {
            const response = await fetch("/api/complete", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ paymentId, txid }),
            });
            if (!response.ok) throw new Error("Server completion failed");
            console.log("Completion response:", await response.json());
          },
          onCancel: () => alert("Payment cancelled"),
          onError: (err) => alert("‚ùå Payment failed: " + (err?.message || err)),
        };

        const payment = await Pi.createPayment(paymentData, callbacks);
        alert("‚úÖ Payment created: " + (payment?.identifier || ""));
      } catch (err) {
        alert("‚ùå Payment failed: " + (err?.message || err));
      }
    }

    // Î≤ÑÌäº Ï∂îÍ∞Ä
    document.body.insertAdjacentHTML('beforeend', `
      <div style="text-align:center; margin-top:20px;">
        <button onclick="testPayment()" style="padding:10px 20px; font-size:16px; background:#6a5acd; color:#fff; border:none; border-radius:6px;">
          Test Pi Payment
        </button>
      </div>
    `);
  </script>
</body>
</html>
